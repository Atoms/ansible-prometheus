---
- hosts: all
  tasks:
    - name: Include test installation variables
      include_vars: ../vars/install.yml

    - name: Install script templates to local "scripts" directory
      copy:
        content: '{{ lookup("template", lookup("env", "PWD") + "/templates/{{ prometheus_script_name }}.sh.j2") }}'
        dest: '{{ lookup("env", "PWD") }}/scripts/{{ prometheus_script_name }}.sh'
        mode: '0750'
      loop_control:
        loop_var: prometheus_script_name
      delegate_to: localhost
      with_items:
       - promcron
       - promrun

    - name: Include install tasks
      include_tasks: ../playbooks/install_common.yml

    - name: Set install filters from environment
      set_fact:
        prometheus_install_only: '{{ lookup("env", "PROMETHEUS_INSTALL_ONLY").split(",") | reject("equalto", "") | list }}'

    - name: Install Prometheus tasks
      include_role:
        name: '../../../../ansible-prometheus'
        tasks_from: '{{ prometheus_component.path | regex_replace("\.yml$", "") }}'
      loop_control:
        loop_var: prometheus_component
      with_items: "{{ tasks.files | sort(attribute='path') }}"
      when: prometheus_install_only | length == 0 or prometheus_component.path | basename in prometheus_install_only
