---
- hosts: all
  tasks:
  - name: Include test installation variables
    include_vars: ../vars/install.yml

  - block:
    - name: Update 'apk' cache
      become: true
      apk:
        update_cache: true
      changed_when: false

    - name: Install coreutils on Alpine <3.9 for 'cp' and 'mv'
      become: true
      package:
        name: coreutils
        state: present
    when:
      - ansible_os_family == 'Alpine'
      - ansible_distribution_version is version('3.9', '<')

  - name: Install node_exporter and promcron
    include_role:
      name: '../../../../ansible-prometheus'
      tasks_from: '{{ prometheus_component }}'
    loop_control:
      loop_var: prometheus_component
    with_items:
       - node_exporter
       - promcron
    vars:
      prometheus_install_sponge: true
      prometheus_script_enable_all: false

  - name: Add group 'app'
    become: true
    group:
      name: app

  - name: Add user 'app'
    become: true
    user:
      name: app
      group: app
